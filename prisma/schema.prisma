generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Multi-Tenant Organization ───────────────────────────────────────────────

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logoUrl     String?
  plan        PlanType @default(FREE)
  maxSeats    Int      @default(5)
  ssoEnabled  Boolean  @default(false)
  ssoProvider String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     OrgMember[]
  teams       Team[]
  roles       Role[]
  projects    Project[]
  apiKeys     ApiKey[]
  auditLogs   AuditLog[]
  invitations Invitation[]
  webhooks    Webhook[]

  @@index([slug])
  @@map("organizations")
}

model OrgMember {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  roleId         String
  status         MemberStatus @default(ACTIVE)
  joinedAt       DateTime     @default(now())
  lastActiveAt   DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role         Role         @relation(fields: [roleId], references: [id])
  teamMembers  TeamMember[]

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([roleId])
  @@map("org_members")
}

// ─── Users & Authentication ──────────────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  avatarUrl     String?
  passwordHash  String?
  emailVerified Boolean   @default(false)
  mfaEnabled    Boolean   @default(false)
  mfaSecret     String?
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  memberships   OrgMember[]
  sessions      Session[]
  oauthAccounts OAuthAccount[]
  createdApiKeys ApiKey[]
  auditLogs     AuditLog[]

  @@index([email])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

model OAuthAccount {
  id           String   @id @default(cuid())
  userId       String
  provider     String
  providerAccountId String
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("oauth_accounts")
}

// ─── RBAC: Roles & Permissions ───────────────────────────────────────────────

model Role {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  isSystem       Boolean  @default(false)
  priority       Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  permissions  RolePermission[]
  members      OrgMember[]

  @@unique([organizationId, name])
  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  resource    String
  action      String
  description String?
  createdAt   DateTime @default(now())

  roles RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  permissionId String
  conditions   Json?
  grantedAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// ─── Teams ───────────────────────────────────────────────────────────────────

model Team {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  isDefault      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members        TeamMember[]
  projectAccess  ProjectTeamAccess[]

  @@unique([organizationId, name])
  @@map("teams")
}

model TeamMember {
  id          String   @id @default(cuid())
  teamId      String
  orgMemberId String
  teamRole    TeamRole @default(MEMBER)
  joinedAt    DateTime @default(now())

  team      Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  orgMember OrgMember @relation(fields: [orgMemberId], references: [id], onDelete: Cascade)

  @@unique([teamId, orgMemberId])
  @@map("team_members")
}

// ─── Projects ────────────────────────────────────────────────────────────────

model Project {
  id             String        @id @default(cuid())
  organizationId String
  name           String
  description    String?
  visibility     Visibility    @default(PRIVATE)
  archived       Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teamAccess   ProjectTeamAccess[]

  @@unique([organizationId, name])
  @@map("projects")
}

model ProjectTeamAccess {
  id        String      @id @default(cuid())
  projectId String
  teamId    String
  access    AccessLevel @default(READ)
  grantedAt DateTime    @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([projectId, teamId])
  @@map("project_team_access")
}

// ─── API Keys ────────────────────────────────────────────────────────────────

model ApiKey {
  id             String    @id @default(cuid())
  organizationId String
  createdById    String
  name           String
  keyHash        String    @unique
  keyPrefix      String
  scopes         String[]
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  revokedAt      DateTime?
  createdAt      DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation(fields: [createdById], references: [id])

  @@index([keyHash])
  @@index([organizationId])
  @@map("api_keys")
}

// ─── Invitations ─────────────────────────────────────────────────────────────

model Invitation {
  id             String           @id @default(cuid())
  organizationId String
  email          String
  roleId         String
  status         InvitationStatus @default(PENDING)
  token          String           @unique
  expiresAt      DateTime
  createdAt      DateTime         @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([token])
  @@map("invitations")
}

// ─── Webhooks ────────────────────────────────────────────────────────────────

model Webhook {
  id             String   @id @default(cuid())
  organizationId String
  url            String
  secret         String
  events         String[]
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deliveryLogs    WebhookDelivery[]

  @@index([organizationId])
  @@map("webhooks")
}

model WebhookDelivery {
  id           String   @id @default(cuid())
  webhookId    String
  event        String
  payload      Json
  responseCode Int?
  responseBody String?
  success      Boolean
  attempts     Int      @default(1)
  deliveredAt  DateTime @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([deliveredAt])
  @@map("webhook_deliveries")
}

// ─── Audit Log ───────────────────────────────────────────────────────────────

model AuditLog {
  id             String   @id @default(cuid())
  organizationId String
  userId         String?
  action         String
  resource       String
  resourceId     String?
  metadata       Json?
  ipAddress      String?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt])
  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum PlanType {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum MemberStatus {
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum TeamRole {
  LEAD
  MEMBER
  VIEWER
}

enum Visibility {
  PUBLIC
  INTERNAL
  PRIVATE
}

enum AccessLevel {
  READ
  WRITE
  ADMIN
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}
