generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  addresses Address[]
  orders    Order[]
  reviews   Review[]

  @@index([email])
}

model Address {
  id         String  @id @default(uuid())
  street     String
  city       String
  state      String
  zipCode    String
  country    String  @default("US")
  isDefault  Boolean @default(false)
  customerId String

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  orders   Order[]

  @@index([customerId])
}

model Order {
  id              String      @id @default(uuid())
  orderNumber     String      @unique
  status          OrderStatus @default(PENDING)
  subtotal        Decimal     @db.Decimal(10, 2)
  tax             Decimal     @db.Decimal(10, 2)
  shippingCost    Decimal     @db.Decimal(10, 2)
  total           Decimal     @db.Decimal(10, 2)
  currency        String      @default("USD")
  notes           String?
  customerId      String
  shippingAddress String
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  customer        Customer     @relation(fields: [customerId], references: [id])
  shippingAddr    Address      @relation(fields: [shippingAddress], references: [id])
  items           OrderItem[]
  payments        Payment[]
  shipments       Shipment[]
  statusHistory   OrderStatusHistory[]

  @@index([customerId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id        String  @id @default(uuid())
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)
  orderId   String
  productId String

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@unique([orderId, productId])
}

model Product {
  id          String  @id @default(uuid())
  sku         String  @unique
  name        String
  description String?
  price       Decimal @db.Decimal(10, 2)
  weight      Decimal? @db.Decimal(8, 2)
  categoryId  String

  category   Category    @relation(fields: [categoryId], references: [id])
  orderItems OrderItem[]
  reviews    Review[]
  inventory  Inventory[]

  @@index([sku])
  @@index([categoryId])
}

model Category {
  id       String  @id @default(uuid())
  name     String  @unique
  slug     String  @unique
  parentId String?

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]
}

model Payment {
  id            String        @id @default(uuid())
  amount        Decimal       @db.Decimal(10, 2)
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?       @unique
  orderId       String
  createdAt     DateTime      @default(now())

  order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([status])
}

model Shipment {
  id             String         @id @default(uuid())
  trackingNumber String?
  carrier        String?
  status         ShipmentStatus @default(PREPARING)
  shippedAt      DateTime?
  deliveredAt    DateTime?
  orderId        String
  createdAt      DateTime       @default(now())

  order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([trackingNumber])
}

model Inventory {
  id          String @id @default(uuid())
  quantity    Int    @default(0)
  reserved    Int    @default(0)
  warehouseId String
  productId   String

  product Product @relation(fields: [productId], references: [id])

  @@unique([warehouseId, productId])
  @@index([warehouseId])
}

model Review {
  id         String   @id @default(uuid())
  rating     Int
  title      String?
  body       String?
  customerId String
  productId  String
  createdAt  DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id])
  product  Product  @relation(fields: [productId], references: [id])

  @@unique([customerId, productId])
  @@index([productId])
}

model OrderStatusHistory {
  id        String      @id @default(uuid())
  fromStatus OrderStatus?
  toStatus  OrderStatus
  note      String?
  orderId   String
  createdAt DateTime    @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  BANK_TRANSFER
  CRYPTO
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}

enum ShipmentStatus {
  PREPARING
  SHIPPED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  RETURNED
}
